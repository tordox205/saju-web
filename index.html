<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì‚¬ì£¼ í’€ì´</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”®</text></svg>">

  <style>
    :root{ --bg:#0f1320; --fg:#eef2ff; --muted:#9aa3b2;
      --card:#141a33; --line:#243055; --accent:#76a7ff;
      --love:#ffe8ef; --money:#e8fff1; --job:#e8f1ff; --health:#fff6e8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      color:var(--fg);
      background:linear-gradient(180deg,#0b1020,#0c1226 35%,#0b1020 100%);
    }
    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    header h1{font-size:22px;margin:0}
    header .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.18);}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    label{display:block; margin:8px 0 6px; font-weight:600}
    input,select,textarea,button{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:#0e1530; color:var(--fg); outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(118,167,255,.2)}
    textarea{min-height:92px; resize:vertical}
    .actions{display:flex; gap:10px; align-items:center; margin-top:8px}
    .btn{
      background:linear-gradient(180deg,#7db3ff,#6aa2ff 60%,#5b94fb 100%);
      color:#091224; border:none; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:transform .05s ease, filter .2s ease; padding:10px 14px; border-radius:12px;
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{filter:grayscale(1); opacity:.6; cursor:not-allowed}
    .out{margin-top:16px}
    .result{border:1px dashed var(--line); border-radius:14px; padding:16px; background:#0e1430;}
    .badges{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 2px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      font-size:12px; border:1px solid rgba(255,255,255,.08); color:#0f172a; font-weight:700}
    .badge.love{background:var(--love)} .badge.money{background:var(--money)}
    .badge.job{background:var(--job)} .badge.health{background:var(--health)}
    .kv{display:grid; grid-template-columns:112px 1fr; gap:10px; margin:10px 0}
    @media (max-width:520px){ .kv{grid-template-columns:1fr} .kv b{display:block;margin-bottom:4px} }
    .muted{color:var(--muted); font-size:13px}
    .small{color:var(--muted); font-size:12px; margin-top:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hl{color:#bfe1ff}
    .tips li{margin:4px 0}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@latest/dist/transformers.min.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ì‚¬ì£¼ í’€ì´</h1>
      <span class="sub">ê°€ë²¼ìš´ í‚¤ì›Œë“œ ë£°ë¡œ ì˜¤ëŠ˜ í•œ ì¤„ ì¡°ì–¸ê¹Œì§€</span>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label for="name">ì´ë¦„</label>
          <input id="name" placeholder="ì´ë¦„(ì„ íƒ)"/>
        </div>
        <div>
          <label for="birth">ìƒë…„ì›”ì¼</label>
          <input id="birth" type="date" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="hour">íƒœì–´ë‚œ ì‹œê°</label>
          <select id="hour">
            <option value="" selected>ì„ íƒí•˜ì„¸ìš”</option>
            <option value="0">ì(23~01)</option><option value="2">ì¶•(01~03)</option>
            <option value="4">ì¸(03~05)</option><option value="6">ë¬˜(05~07)</option>
            <option value="8">ì§„(07~09)</option><option value="10">ì‚¬(09~11)</option>
            <option value="12">ì˜¤(11~13)</option><option value="14">ë¯¸(13~15)</option>
            <option value="16">ì‹ (15~17)</option><option value="18">ìœ (17~19)</option>
            <option value="20">ìˆ (19~21)</option><option value="22">í•´(21~23)</option>
          </select>
          <div class="small">ì •í™•í•œ ì‹œê°ì„ ëª¨ë¥´ë©´ ëŒ€ëµ ê·¼ì‚¬ê°’ì„ ì„ íƒí•´ë„ ë©ë‹ˆë‹¤.</div>
        </div>
        <div>
          <label for="q">ì§ˆë¬¸/ê³ ë¯¼(ì„ íƒ)</label>
          <textarea id="q" placeholder=""></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="run" class="btn">í’€ì´í•˜ê¸°</button>
        <span class="muted mono">Enterë¡œë„ ì‹¤í–‰(ì§ˆë¬¸ì¹¸ ì œì™¸)</span>
      </div>

      <div class="out">
        <div id="out" class="result muted">ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
        <p class="small">â€» êµìœ¡/ì˜¤ë½ìš© ë°ëª¨ì…ë‹ˆë‹¤. ê±´ê°•Â·ë²•ë¥ Â·íˆ¬ì ë“±ì€ ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
      </div>
    </section>
  </div>

  <script>
    const pickName = (cands, names) => cands.find(c => names.includes(c)) ?? names[0];

    document.addEventListener('DOMContentLoaded', async () => {
      if (!window.transformers) {
        console.error('Transformers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        document.getElementById('out').textContent = 'âš  ì˜¤ë¥˜: Transformers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        return;
      }

      const { env, AutoTokenizer } = window.transformers;

      // --- ì„¤ì • ---
      env.allowLocalModels = true;
      env.localModelPath = './'; // ë£¨íŠ¸ì— /web_model/** í•„ìš”
      const MODEL_URL = 'https://github.com/tordox205/saju-web/releases/download/v1/model.onnx';

      try {
        // --- ì´ˆê¸°í™” ---
        const tokenizer = await AutoTokenizer.from_pretrained('web_model');

        // `ort` ê°ì²´ëŠ” `transformers.js`ì— í¬í•¨ë˜ì–´ ìˆì–´ ë³„ë„ë¡œ ë¡œë“œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        window.ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;
        const providers = ('gpu' in navigator) ? ['webgpu','wasm'] : ['wasm'];
        const session = await window.ort.InferenceSession.create(MODEL_URL, {
          executionProviders: providers,
          graphOptimizationLevel: 'all',
        });

        // --- ìœ í‹¸ ---
        async function encodeText(text){
          const e = (tokenizer.encode) ? await tokenizer.encode(text) : await tokenizer(text);
          if (e?.ids) return e.ids;
          if (e?.input_ids?.data) return Array.from(e.input_ids.data);
          if (Array.isArray(e?.input_ids)) return e.input_ids;
          throw new Error('tokenize ì‹¤íŒ¨');
        }
        async function decodeIds(ids){
          if (tokenizer.decode) return await tokenizer.decode(ids, { skip_special_tokens: true });
          if (tokenizer.batch_decode) return (await tokenizer.batch_decode([ids], { skip_special_tokens: true }))[0];
          throw new Error('decode ì‹¤íŒ¨');
        }
        async function generateGreedy(prompt, maxNew=220){
          let ids = Int32Array.from(await encodeText(prompt));

          const name_in = pickName(['input_ids','inputs','tokens'], session.inputNames);
          const name_mask = pickName(['attention_mask','attn_mask','mask'], session.inputNames);
          const name_out = pickName(['logits','output','logits_out'], session.outputNames);

          const eos = (typeof window.eosId === 'number') ? window.eosId : -1;

          for (let step=0; step<maxNew; step++){
            const mask = new Int32Array(ids.length).fill(1);
            const feeds = { [name_in]: new window.ort.Tensor('int32', ids, [1, ids.length]) };
            if (name_mask) feeds[name_mask] = new window.ort.Tensor('int32', mask, [1, mask.length]);

            const out = await session.run(feeds);
            const logits = out[name_out];
            const seqLen = logits.dims[1], V = logits.dims[2];
            const base = (seqLen - 1) * V;

            let nextId = 0, best = -Infinity;
            for (let i=0;i<V;i++){
              const v = logits.data[base + i];
              if (v > best){ best = v; nextId = i; }
            }
            if (nextId === eos) break;

            const next = new Int32Array(ids.length + 1);
            next.set(ids); next[ids.length] = nextId; ids = next;
          }
          return await decodeIds(Array.from(ids));
        }

        function buildPrompt({name,birth,hour,q}){
          const who = name ? `ì´ë¦„: ${name}\n` : '';
          const hr = hour || 'ëª¨ë¦„(ê·¼ì‚¬)';
          const qq = q ? `ì§ˆë¬¸: ${q}\n` : '';
          return `[ì‚¬ì£¼ì…ë ¥]
${who}ìƒë…„ì›”ì¼: ${birth}
íƒœì–´ë‚œ ì‹œê°: ${hr}
${qq}[ì§€ì‹œ]
- ì—°ì• /ê¸ˆì „/ì§ì—…/ê±´ê°• ì¤‘ì‹¬ìœ¼ë¡œ ê°„ë‹¨ í‚¤ì›Œë“œ í’€ì´ í›„ ì˜¤ëŠ˜ì˜ í•œ ì¤„.
- ê³¼ì¥ ê¸ˆì§€, ë³´ìˆ˜ì  í†¤.
[ì¶œë ¥]`;
        }

        // --- UI ---
        const btn = document.getElementById('run');
        const out = document.getElementById('out');

        btn.addEventListener('click', async ()=>{
          const name = (document.getElementById('name').value||'').trim();
          const birth = document.getElementById('birth').value;
          const hour = document.getElementById('hour').value;
          const q = (document.getElementById('q')?.value||'').trim();

          if (!birth){ out.textContent='ìƒë…„ì›”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'; return; }

          btn.disabled = true; out.textContent = 'ìƒì„± ì¤‘â€¦';
          try{
            const prompt = buildPrompt({name,birth,hour,q});
            const text = await generateGreedy(prompt, 220);
            out.textContent = (text||'').replaceAll('<unk>','').trim() || 'ê²°ê³¼ ì—†ìŒ';
          }catch(e){
            console.error(e);
            out.textContent = 'âš  ì˜¤ë¥˜: ' + (e?.message || e);
          }finally{
            btn.disabled = false;
          }
        });

        document.addEventListener('keydown',(e)=>{
          const active = document.activeElement;
          if(e.key==='Enter' && active && active.id!=='q'){
            e.preventDefault(); btn.click();
          }
        });

        // ë””ë²„ê·¸ í—¬í¼
        window.testONNX = async () => {
          try {
            const enc = (await tokenizer.encode('í…ŒìŠ¤íŠ¸')).ids;
            const name_in = pickName(['input_ids','inputs','tokens'], session.inputNames);
            const name_mask = pickName(['attention_mask','attn_mask','mask'], session.inputNames);
            const out = await session.run({
              [name_in]: new window.ort.Tensor('int32', Int32Array.from(enc), [1, enc.length]),
              [name_mask]: new window.ort.Tensor('int32', new Int32Array(enc.length).fill(1), [1, enc.length]),
            });
            return Object.keys(out);
          } catch (e) {
            return 'run error: ' + (e?.message || e);
          }
        };
      } catch (err) {
        console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        document.getElementById('out').textContent = 'ì´ˆê¸°í™” ì˜¤ë¥˜: ' + (err?.message || err);
      }
    });
  </script>
</body>
</html>