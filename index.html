<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>사주 풀이</title>
  <style>
    :root{
      --bg:#0f1320; --fg:#eef2ff; --muted:#9aa3b2;
      --card:#141a33; --line:#243055; --accent:#76a7ff;
      --love:#ffe8ef; --money:#e8fff1; --job:#e8f1ff; --health:#fff6e8;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      color:var(--fg);
      background:linear-gradient(180deg,#0b1020,#0c1226 35%,#0b1020 100%);
    }
    .wrap{max-width:880px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    header h1{font-size:22px;margin:0}
    header .sub{color:var(--muted);font-size:13px}

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    label{display:block; margin:8px 0 6px; font-weight:600}
    input,select,textarea,button{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      background:#0e1530; color:var(--fg); outline:none;
    }
    input:focus,select:focus,textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(118,167,255,.2)}
    textarea{min-height:92px; resize:vertical}

    .actions{display:flex; gap:10px; align-items:center; margin-top:8px}
    .btn{
      background:linear-gradient(180deg,#7db3ff,#6aa2ff 60%,#5b94fb 100%);
      color:#091224; border:none; font-weight:700; letter-spacing:.2px; cursor:pointer;
      transition:transform .05s ease, filter .2s ease; padding:10px 14px; border-radius:12px;
    }
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{filter:grayscale(1); opacity:.6; cursor:not-allowed}

    .out{margin-top:16px}
    .result{
      border:1px dashed var(--line); border-radius:14px; padding:16px; background:#0e1430;
    }
    .badges{display:flex; flex-wrap:wrap; gap:8px; margin:6px 0 2px}
    .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      font-size:12px; border:1px solid rgba(255,255,255,.08); color:#0f172a; font-weight:700}
    .badge.love{background:var(--love)} .badge.money{background:var(--money)}
    .badge.job{background:var(--job)} .badge.health{background:var(--health)}

    .kv{display:grid; grid-template-columns:112px 1fr; gap:10px; margin:10px 0}
    @media (max-width:520px){ .kv{grid-template-columns:1fr} .kv b{display:block;margin-bottom:4px} }
    .muted{color:var(--muted); font-size:13px}
    .small{color:var(--muted); font-size:12px; margin-top:10px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .hl{color:#bfe1ff}
    .tips li{margin:4px 0}
  </style>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<!-- onnxruntime: 그대로 유지 -->
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<!-- Transformers (ESM)을 모듈로 가져와 window에 붙여줌 -->
<script type="module">
  import { env, AutoTokenizer } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@3.1.0';
  // 기존 코드가 window.transformers를 기대하므로 전역으로 노출
  window.transformers = { env, AutoTokenizer };
</script>

</head>
<body>
  <div class="wrap">
    <header>
      <h1>사주 풀이</h1>
      <span class="sub">가벼운 키워드 룰로 오늘 한 줄 조언까지</span>
    </header>

    <section class="card">
      <div class="grid">
        <div>
          <label for="name">이름</label>
          <input id="name" placeholder="이름(선택)"/>
        </div>
        <div>
          <label for="birth">생년월일</label>
          <input id="birth" type="date" />
        </div>
      </div>

      <div class="grid">
        <div>
          <label for="hour">태어난 시각</label>
          <select id="hour">
            <option value="" selected>선택하세요</option>
            <option value="0">자(23~01)</option><option value="2">축(01~03)</option>
            <option value="4">인(03~05)</option><option value="6">묘(05~07)</option>
            <option value="8">진(07~09)</option><option value="10">사(09~11)</option>
            <option value="12">오(11~13)</option><option value="14">미(13~15)</option>
            <option value="16">신(15~17)</option><option value="18">유(17~19)</option>
            <option value="20">술(19~21)</option><option value="22">해(21~23)</option>
          </select>
          <div class="small">정확한 시각을 모르면 대략 근사값을 선택해도 됩니다.</div>
        </div>
        <div>
          <label for="q">질문/고민(선택)</label>
          <textarea id="q" placeholder=""></textarea>
        </div>
      </div>

      <div class="actions">
        <button id="run" class="btn">풀이하기</button>
        <span class="muted mono">Enter로도 실행(질문칸 제외)</span>
      </div>

      <div class="out">
        <div id="out" class="result muted">여기에 결과가 표시됩니다.</div>
        <p class="small">※ 교육/오락용 데모입니다. 건강·법률·투자 등은 전문가 상담을 권장합니다.</p>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <details>
        <summary class="muted">간단 사용 팁</summary>
        <ul class="tips muted">
          <li>질문에 “연애, 금전, 직장, 학업, 건강” 같은 키워드를 넣으면 현실 조언이 더 구체화됩니다.</li>
          <li>이름/시각이 같아도 날짜가 다르면 결과 키워드가 달라질 수 있어요.</li>
        </ul>
      </details>
    </section>
  </div>

    <script>
  /** ONNX + Tokenizer 로더 (Release의 model.onnx 사용) **/
  const MODEL_URL =
    'https://github.com/tordox205/saju-web/releases/download/v1/model.onnx';

  let ortSession = null;
  let tokenizer  = null;

  (async () => {
    try {
      // 토크나이저: 레포 내 web_model/ 에서 로드(작은 파일)
      const { env, AutoTokenizer } = window.transformers;
      env.allowLocalModels = true;
      env.localModelPath  = './';
      tokenizer = await AutoTokenizer.from_pretrained('web_model');

      // ONNX 세션: GitHub Releases의 절대 URL 사용
      ort.env.wasm.numThreads = navigator.hardwareConcurrency || 4;
      ortSession = await ort.InferenceSession.create(MODEL_URL, {
        executionProviders: ['webgpu','wasm'],
        graphOptimizationLevel: 'all',
      });

      console.log('[ONNX] ready');
      window.onnxReady = true;
    } catch (e) {
      console.error('[ONNX loader error]', e);
    }
  })();

  // 콘솔에서 상태 확인용
  window.testONNX = async () => {
    if (!tokenizer || !ortSession) return 'not ready';
    try {
      const enc = (await tokenizer.encode('테스트')).ids;
      const input_ids = new ort.Tensor('int32', Int32Array.from(enc), [1, enc.length]);
      const attention_mask = new ort.Tensor('int32', new Int32Array(enc.length).fill(1), [1, enc.length]);
      const out = await ortSession.run({ input_ids, attention_mask });
      return Object.keys(out); // 예: ["logits"]
    } catch (e) {
      return 'run error: ' + (e?.message || e);
    }
  };
  </script>

  <!-- ↓↓↓ 생성/버튼 연결 블록 (두 번째 스크립트) ↓↓↓ -->
  <script>
  // ====== 간단 생성기(그리디) + 버튼 연결 ======
  function pickName(cands, names){ for(const c of cands) if(names.includes(c)) return c; return names[0]; }

  async function encodeText(text){
    const e = (tokenizer.encode) ? await tokenizer.encode(text) : await tokenizer(text);
    if (e?.ids) return e.ids;
    if (e?.input_ids?.data) return Array.from(e.input_ids.data);
    if (Array.isArray(e?.input_ids)) return e.input_ids;
    throw new Error('tokenize 실패');
  }
  async function decodeIds(ids){
    if (tokenizer.decode) return await tokenizer.decode(ids, { skip_special_tokens: true });
    if (tokenizer.batch_decode) return (await tokenizer.batch_decode([ids], { skip_special_tokens: true }))[0];
    throw new Error('decode 실패');
  }

  async function generateGreedy(prompt, maxNew=220){
    if (!ortSession || !tokenizer) throw new Error('모델 준비 안됨');
    let ids = Int32Array.from(await encodeText(prompt));

    // 세션 입출력명 자동 탐지
    const inNames = ortSession.inputNames, outNames = ortSession.outputNames;
    const name_input = pickName(['input_ids','inputs','tokens'], inNames);
    const name_mask  = pickName(['attention_mask','attn_mask','mask'], inNames);
    const name_logits= pickName(['logits','output','logits_out'], outNames);

    const eos = (typeof window.eosId === 'number') ? window.eosId : -1;

    for (let step=0; step<maxNew; step++){
      const mask = new Int32Array(ids.length).fill(1);
      const feeds = {};
      feeds[name_input] = new ort.Tensor('int32', ids, [1, ids.length]);
      feeds[name_mask]  = new ort.Tensor('int32', mask, [1, mask.length]);

      const out = await ortSession.run(feeds);
      const logits = out[name_logits];
      const seqLen = logits.dims[1], V = logits.dims[2];
      const base = (seqLen - 1) * V;

      let nextId = 0, best = -Infinity;
      for (let i=0;i<V;i++){ const v = logits.data[base + i]; if (v > best){ best=v; nextId=i; } }
      if (nextId === eos) break;

      const next = new Int32Array(ids.length + 1);
      next.set(ids); next[ids.length] = nextId; ids = next;
    }
    return await decodeIds(Array.from(ids));
  }

  function buildPrompt({name,birth,hour,q}){
    const who = name ? `이름: ${name}\n` : '';
    const hr  = hour || '모름(근사)';
    const qq  = q ? `질문: ${q}\n` : '';
    return `[사주입력]
${who}생년월일: ${birth}
태어난 시각: ${hr}
${qq}[지시]
- 연애/금전/직업/건강 중심으로 간단 키워드 풀이 후 오늘의 한 줄.
- 과장 금지, 보수적 톤.
[출력]`;
  }

  (function wireUI(){
    const btn = document.getElementById('run');
    const out = document.getElementById('out');
    btn.addEventListener('click', async ()=>{
      const name  = (document.getElementById('name').value||'').trim();
      const birth = document.getElementById('birth').value;
      const hour  = document.getElementById('hour').value;
      const q     = (document.getElementById('q').value||'').trim();
      if (!birth){ out.textContent='생년월일을 입력하세요.'; return; }
      if (!ortSession || !tokenizer){ out.textContent='모델 준비 중입니다. 잠시 후 다시.'; return; }

      btn.disabled = true; out.textContent = '생성 중…';
      try{
        const prompt = buildPrompt({name,birth,hour,q});
        const text = await generateGreedy(prompt, 220);
        out.textContent = (text||'').replaceAll('<unk>','').trim() || '결과 없음';
      }catch(e){
        console.error(e);
        out.textContent = '⚠ 오류: ' + (e?.message || e);
      }finally{
        btn.disabled = false;
      }
    });

    document.addEventListener('keydown',(e)=>{
      const active = document.activeElement;
      if(e.key==='Enter' && active && active.id!=='q'){
        e.preventDefault(); btn.click();
      }
    });
  })();
  </script>
</body>
</html>




